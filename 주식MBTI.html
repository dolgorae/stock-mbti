<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>주식 MBTI 테스트</title>

  <!-- 기본 메타 (공유시 플랫폼이 JS로 바뀐 메타를 잘 반영 안 하는 경우가 많아서 "최소"만 둠) -->
  <meta name="description" content="12문항으로 알아보는 주식 MBTI(UD/CF/KS/XA) 테스트" />
  <meta property="og:title" content="주식 MBTI 테스트" />
  <meta property="og:description" content="12문항으로 알아보는 주식 MBTI(UD/CF/KS/XA) 테스트" />

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666; --line:#e9e9e9; --card:#fafafa;
      --btn:#111; --btnText:#fff; --btn2Bg:#fff; --btn2Text:#111;
      --danger:#b00020;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;line-height:1.5;background:var(--bg);color:var(--text);}
    .wrap{max-width:920px;margin:0 auto;}
    .card{padding:20px;border:1px solid #ddd;border-radius:14px;}
    h1{margin:0 0 8px;}
    .muted{color:var(--muted);font-size:.96rem;}
    .q{padding:14px 0;border-top:1px solid var(--line);}
    .q:first-of-type{border-top:0;}
    .opts{display:grid;gap:8px;margin-top:8px;}
    label{display:block;padding:10px 12px;border:1px solid #ddd;border-radius:10px;cursor:pointer;background:#fff;}
    label:hover{border-color:#bbb;}
    input{margin-right:8px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{padding:12px 14px;border-radius:12px;border:1px solid var(--btn);background:var(--btn);color:var(--btnText);cursor:pointer;}
    button.secondary{background:var(--btn2Bg);color:var(--btn2Text);border-color:#ddd;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .result{margin-top:16px;padding:16px;border:1px solid #ddd;border-radius:12px;background:var(--card);}
    .err{color:var(--danger);font-weight:700;}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;margin:0 6px 6px 0;background:#fff;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:760px){ .grid2{grid-template-columns:1fr;} }
    .box{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;}
    ul{margin:8px 0 0 18px;}
    .hr{height:1px;background:var(--line);margin:14px 0;}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;}
    .small{font-size:.9rem;}
    .linklike{color:#0b57d0;text-decoration:underline;cursor:pointer;}
    .badge{display:inline-block;padding:4px 8px;border-radius:10px;background:#111;color:#fff;font-size:.85rem;}
    canvas{max-width:100%;border:1px solid #eee;border-radius:12px;background:#fff;}
  </style>
</head>

<body>
<div class="wrap">
  <!-- INTRO / QUIZ PAGE -->
  <section id="page-quiz" class="card">
    <div class="topbar">
      <div>
        <h1>주식 MBTI 테스트</h1>
        <div class="muted">12문항 A/B 선택 → 4글자 타입( U/D · C/F · K/S · X/A )이 나옵니다.</div>
      </div>
    </div>

    <div class="hr"></div>

    <form id="quiz"></form>

    <div class="row" style="margin-top:16px;">
      <button type="button" id="calcBtn">결과 보기</button>
      <button type="button" id="resetBtn" class="secondary">다시하기</button>
      <span class="muted" id="status"></span>
    </div>

    <div id="quizMsg" class="result" style="display:none;"></div>
  </section>

  <!-- RESULT PAGE -->
  <section id="page-result" class="card" style="display:none; margin-top:18px;">
    <div class="topbar">
      <div>
        <h1 id="resTitle">결과</h1>
        <div class="muted" id="resSubtitle"></div>
      </div>
      <div class="row">
        <button type="button" id="backBtn" class="secondary">문항으로</button>
        <button type="button" id="retryBtn" class="secondary">재테스트</button>
      </div>
    </div>

    <div class="result" id="resMain">
      <!-- filled by JS -->
    </div>

    <div class="result" id="shareBox">
      <b>공유 / SNS 게시</b>
      <div class="muted small" style="margin-top:6px;">
        링크를 공유하면, 받는 사람이 바로 결과 페이지로 진입합니다.
      </div>

      <div class="hr"></div>

      <div class="row" style="margin-top:10px;">
        <button type="button" id="copyLinkBtn">결과 링크 복사</button>
        <button type="button" id="copyTextBtn" class="secondary">결과 문구 복사</button>
        <button type="button" id="webShareBtn" class="secondary">공유하기(모바일)</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <a id="shareX" class="linklike" target="_blank" rel="noopener">X(트위터)로</a>
        <a id="shareFB" class="linklike" target="_blank" rel="noopener">Facebook으로</a>
        <a id="shareLI" class="linklike" target="_blank" rel="noopener">LinkedIn으로</a>
      </div>

      <div class="hr"></div>

      <b>공유 카드 이미지(저장해서 SNS에 올리기)</b>
      <div class="muted small" style="margin-top:6px;">아래 카드 이미지를 생성한 뒤 “이미지 저장”으로 다운로드할 수 있어요.</div>

      <div style="margin-top:10px;">
        <canvas id="shareCanvas" width="1200" height="630"></canvas>
      </div>
      <div class="row" style="margin-top:10px;">
        <button type="button" id="regenCardBtn" class="secondary">카드 다시 생성</button>
        <button type="button" id="downloadCardBtn">이미지 저장</button>
      </div>

      <div class="muted small" id="shareStatus" style="margin-top:8px;"></div>
    </div>
  </section>
</div>

<script>
/* -----------------------------
   데이터: 4축 정의 & 문항
------------------------------ */

const AXIS = {
  trend: { A:"U", B:"D", label:"추세 편안함" },
  basis: { A:"C", B:"F", label:"의사결정 근거" },
  build: { A:"K", B:"S", label:"포지션 구축" },
  loss:  { A:"X", B:"A", label:"손실 대처" },
};

// 12문항(각 축 3문항). axis만 유지되면 순서는 섞여도 무방.
const QUESTIONS = [
  // trend (U/D)
  { axis:"trend", q:"매수 버튼이 가장 편해지는 순간은?", A:"신고가/우상향 흐름이 ‘확인’됐을 때", B:"조정으로 가격이 내려와 ‘부담’이 줄었을 때" },
  { axis:"trend", q:"차트가 이럴 때 더 매력적으로 느껴진다", A:"고점 갱신 + 거래대금도 받쳐준다", B:"크게 빠진 뒤 바닥 다지며 변동성이 줄어든다" },
  { axis:"trend", q:"마음이 불편한 쪽은?", A:"계속 빠지는 종목을 사는 것", B:"이미 많이 오른 종목을 사는 것" },

  // basis (C/F)
  { axis:"basis", q:"매수 이유를 설명할 때 더 자연스러운 건?", A:"이평/추세/거래대금/수급 신호", B:"실적/밸류/산업 흐름 변화" },
  { axis:"basis", q:"뉴스가 나왔을 때 먼저 보는 것은?", A:"차트 반응(갭, 거래대금, 돌파/눌림)", B:"펀더 변화(가이던스, 마진, 수요)" },
  { axis:"basis", q:"종목을 ‘좋다’고 느끼는 핵심", A:"가격이 말해준다(차트가 강하면 이유가 있다)", B:"숫자/스토리가 말해준다(기업이 강하면 결국 간다)" },

  // build (K/S)
  { axis:"build", q:"계좌에서 가장 편한 구성은?", A:"확신 1~3개에 비중 크게", B:"여러 개로 분산, 한 종목 비중은 작게" },
  { axis:"build", q:"‘기회가 왔다’ 싶을 때 행동", A:"한두 종목에 비중을 빠르게 실는다", B:"포트 전체에서 분할로 넓게 담는다" },
  { axis:"build", q:"더 싫은 상황은?", A:"분산해서 수익 밋밋 + 정답 종목 못 맞춘 느낌", B:"한 종목이 크게 흔들려 계좌 요동" },

  // loss (X/A)
  { axis:"loss", q:"매수 후 -7%가 됐다. 더 가까운 반응은?", A:"기준 깨지면 일단 컷, 다시 들어가도 됨", B:"이유가 살아있으면 분할로 평단 낮춤" },
  { axis:"loss", q:"손절에 대한 본능", A:"작게 지고 크게 이긴다", B:"내가 틀린 게 아니라 타이밍 문제" },
  { axis:"loss", q:"하락장에서 더 자주 하는 행동", A:"정리/현금 비중 확대", B:"추가매수로 구간 만든다(버틴다)" },
];

// 16타입 해설(정체성 문구 + 성향 + 강점/약점)
// *예시로 투자자/아키타입을 붙였고, 원하면 톤(밈/진지/중립)도 바꿀 수 있음.
const TYPE_DETAILS = {
  UCKX: {
    identity: "조지 소로스형 (모멘텀 스나이퍼)",
    tendency:
      "강한 흐름이 포착되는 순간, 망설임 없이 ‘핵심 한 방’으로 들어가 승부를 봅니다. 대신 기준이 무너지면 미련 없이 빠져나오는, 공격적이지만 규칙에 강한 타입이에요.",
    strengths: ["승률보다 손익비 중심이라 계좌 방어가 가능", "강세장/테마장에서 폭발력이 큼", "실패를 빨리 인정해 큰 손실을 막음"],
    weaknesses: ["너무 빨리 잘라 ‘나가면 오르는’ 경험이 잦을 수 있음", "횡보장에서 신호 과민으로 잦은 매매", "상승 추세에 과신하면 추격매수 위험"],
  },
  UCKA: {
    identity: "뇌동+신념 혼합형 (불꽃 평단러)",
    tendency:
      "상승세가 붙은 종목을 만나면 ‘이건 된다’ 싶을 때 과감히 비중을 싣는 편입니다. 흔들림이 와도 쉽게 포기하지 않고, 평단을 설계하며 반전을 노리는 강한 추진력의 타입이에요.",
    strengths: ["맞는 종목이면 수익이 크게 남", "상승 추세의 중간 조정은 잘 버팀", "확신이 강해 실행력이 좋음"],
    weaknesses: ["추세가 꺾였는데도 평단으로 늪에 빠질 수 있음", "집중 리스크 + 물타기 리스크가 겹칠 수 있음", "손실관리 룰이 약해지기 쉬움"],
  },
  UCSX: {
    identity: "레이 달리오형 (트렌드 리밸런서)",
    tendency:
      "강한 추세를 여러 종목으로 넓게 담아 ‘트렌드 바구니’를 만들고, 약해지는 신호가 보이면 빠르게 갈아탑니다. 한 방보단 꾸준히 이기는 운영형 플레이어에 가깝습니다.",
    strengths: ["단일 종목 리스크가 낮음", "포트 회전으로 추세를 따라가기 좋음", "규칙 손절로 대형 사고 방지"],
    weaknesses: ["분산으로 수익이 밋밋해 보일 수 있음", "리밸런싱이 잦으면 수수료/피로 누적", "강한 한 방 종목을 끝까지 못 들고 갈 수 있음"],
  },
  UCSA: {
    identity: "사업가형 (상승 적립러)",
    tendency:
      "오르는 종목을 ‘천천히 키우는 자산’처럼 대하며 분산으로 쌓아갑니다. 조정이 오면 겁내기보다 ‘좋은 가격’으로 받아내는 편이라, 장기전에서 강해요.",
    strengths: ["추세 유지 구간에서 평균적으로 유리", "심리적으로 흔들림이 덜함", "분할매수로 진입 타이밍 스트레스 감소"],
    weaknesses: ["추세 전환을 늦게 인정하면 손실이 커질 수 있음", "분산이라 의외로 ‘결정타’가 약할 수 있음", "하락장에서 ‘적립’이 ‘물타기’로 변질될 위험"],
  },

  UFKX: {
    identity: "성장+규율형 (실적 돌파주의자)",
    tendency:
      "성장/실적의 근거가 탄탄한 종목이 시장에서 힘을 받기 시작하면 집중해서 올라탑니다. 다만 스토리가 훼손되면 빠르게 인정하고 정리하는, 펀더 기반의 프로다운 타입입니다.",
    strengths: ["펀더+가격 확인을 함께 써서 안정적", "손절 기준이 ‘논리’라 감정 개입이 적음", "강세장에서 성과가 잘 남"],
    weaknesses: ["가정 점검이 늦으면 손절도 늦어질 수 있음", "‘좋은 기업’에 과신하면 추격 위험", "집중 포지션 변동성 스트레스"],
  },
  UFKA: {
    identity: "워렌 버핏형 (신념 홀더)",
    tendency:
      "좋은 기업을 찾으면 그 믿음이 쉽게 흔들리지 않습니다. 단기 등락보다 ‘결국 갈 곳까지 간다’는 확신으로 버티며 키워가려는, 큰 파도를 타는 장기 승부사 타입이에요.",
    strengths: ["큰 추세를 먹을 때 수익이 매우 큼", "뉴스/노이즈에 덜 흔들림", "리서치가 깊어질수록 강해짐"],
    weaknesses: ["손절이 약해 최악의 경우 ‘장기존버’ 늪", "집중+평단은 리스크가 급격히 커질 수 있음", "‘내가 옳다’ 확증편향 경계 필요"],
  },
  UFSX: {
    identity: "기관 PM형 (펀더 리밸런서)",
    tendency:
      "‘괜찮은 기업들’로 포트를 짜고, 상황이 달라지면 냉정하게 리밸런싱합니다. 흥분보다 구조를 믿는 편이라, 장기적으로 안정적인 성과를 내기 쉬운 타입입니다.",
    strengths: ["리스크 관리와 일관성이 좋음", "종목 교체로 포트 질을 유지", "수익과 방어의 밸런스"],
    weaknesses: ["대박 수익보단 꾸준한 수익에 가까움", "리밸런싱 기준이 모호하면 흔들림", "시장 급변 시 판단 피로 증가"],
  },
  UFSA: {
    identity: "연금 운용형 (장기 분산 신자)",
    tendency:
      "검증된 펀더를 바탕으로 분산 포트를 만들고, 시장 소음에는 크게 흔들리지 않습니다. 조정은 ‘장기 적립의 기회’로 받아들이는 편이라 마음이 편한 투자 스타일이에요.",
    strengths: ["심리 안정감 최고", "시간을 아군으로 쓰기 좋음", "분산으로 회복력이 있음"],
    weaknesses: ["명확한 손절 부재 시 ‘좀비 종목’ 누적", "장기라는 이유로 점검을 소홀히 할 수 있음", "상승장에서 수익률이 답답할 수 있음"],
  },

  DCKX: {
    identity: "냉정한 역추세형 (눌림 사냥꾼)",
    tendency:
      "가격이 눌려 ‘좋은 자리’가 보이면 집중해서 빠르게 수익을 노립니다. 다만 반등이 안 나오면 바로 손을 떼는 편이라, 역추세를 하되 사고는 피하려는 냉정함이 있습니다.",
    strengths: ["리스크 대비 진입 가격이 유리", "짧은 반등에서도 수익화 가능", "손절이 있어 ‘떨어지는 칼’ 방지"],
    weaknesses: ["너무 이른 역추세 시도는 연속 손절", "바닥 집착이 생기면 기회비용 커짐", "강세장에서 추세를 놓칠 수 있음"],
  },
  DCKA: {
    identity: "‘바닥’ 장인형 (평단 빌더)",
    tendency:
      "공포 구간에서도 담담하게 ‘구간 매수’를 설계하는 타입입니다. 바닥 근처에서 판을 잘 짜면 한 번에 판을 뒤집는 재미가 있지만, 리스크 관리 룰이 생명입니다.",
    strengths: ["반등이 오면 회복/수익이 빠름", "평단 설계가 잘되면 손익구조가 좋음", "공포구간 실행력이 뛰어남"],
    weaknesses: ["최악의 경우 ‘물타기 무한’ 늪", "집중 포지션이면 심리/계좌 타격 큼", "하락 추세가 길어지면 버티기 비용 증가"],
  },
  DCSX: {
    identity: "퀀트 분할매매형 (딥-스위처)",
    tendency:
      "눌림이 온 종목들을 분산으로 담되, 반등이 약하면 미련 없이 교체합니다. ‘바닥 맞히기’보다 ‘이길 확률이 높은 자리만 남기는’ 실전형 운영 스타일이에요.",
    strengths: ["단일 종목 리스크 낮음", "실패 포지션을 빨리 정리", "변동성 장에서 생존력이 좋음"],
    weaknesses: ["바닥 정확도보다 ‘회전’에 의존할 수 있음", "수익이 잔잔하게 느껴질 수 있음", "교체 기준이 약하면 흔들림"],
  },
  DCSA: {
    identity: "물타기 포트형 (구간 설계러)",
    tendency:
      "하락은 싫지만, 좋은 가격대는 놓치기 싫어서 분산으로 천천히 담아갑니다. 조정이 이어지면 평단을 관리하며 ‘회복 구간’을 만드는 편이라, 구간 플레이에 강합니다.",
    strengths: ["진입 스트레스가 적음", "반등 시 포트 회복이 빠를 수 있음", "분산이라 심리 부담 완화"],
    weaknesses: ["하락장 길어지면 종목이 쌓임", "평단이 ‘관리’가 아니라 ‘습관’이 될 위험", "손실 확정이 늦어질 수 있음"],
  },

  DFKX: {
    identity: "가치 스토커형 (안전마진 컷)",
    tendency:
      "싸졌을 때만 들어가고, 전제(가정)가 틀리면 바로 정리하는 타입입니다. ‘가치’의 맛은 보되 늪에는 빠지지 않으려는, 안전마진+규율의 조합이에요.",
    strengths: ["진입가격이 유리해 손익비가 좋음", "논리 기반 손절로 대형 손실 방지", "리서치의 힘이 성과로 연결"],
    weaknesses: ["‘싸 보이는’ 함정(가치 함정) 경계 필요", "역추세는 인내가 필요해 피로 누적", "강세장 모멘텀을 놓칠 수 있음"],
  },
  DFKA: {
    identity: "강한 가치 신앙형 (버핏-딥)",
    tendency:
      "가격이 눌릴수록 ‘기회’가 또렷해지고, 확신이 들면 더 담습니다. 바닥권에서 큰 수익을 만들 수 있는 타입이지만, 점검과 리스크 관리가 반드시 따라야 빛나요.",
    strengths: ["리서치 기반 확신이 강함", "바닥권에서 큰 수익을 만들 수 있음", "노이즈에 덜 흔들림"],
    weaknesses: ["가치 함정이면 회복이 매우 오래 걸림", "손절 부재로 손실이 커질 수 있음", "집중+평단은 리스크가 급격히 증가"],
  },
  DFSX: {
    identity: "보수적 운용형 (안전마진 포트)",
    tendency:
      "저평가 종목을 분산으로 담아 ‘튼튼한 방어막’을 만들고, 훼손 신호가 보이면 정리합니다. 큰 대박보다 ‘지지 않는 투자’를 선호하는 안정형 타입입니다.",
    strengths: ["하락장에서 생존 확률이 높음", "리스크 관리가 구조화되어 있음", "극단적 손실을 피하기 좋음"],
    weaknesses: ["큰 상승장에서 수익률이 답답할 수 있음", "분산이 과하면 확신이 희석", "‘안전’에 집착하면 성장 기회 상실"],
  },
  DFSA: {
    identity: "국밥 밸류형 (느긋한 분산러)",
    tendency:
      "싼 종목을 분산으로 모아두고, 시장이 흔들릴수록 더 차분해지는 편입니다. 느긋하게 회복을 기다리며 평단을 관리하는 스타일이라, 심리적으로 오래 버티기 좋습니다.",
    strengths: ["심리적으로 편안하고 지속 가능", "분산+평단으로 회복력이 있을 수 있음", "공포 구간에서 실행 가능"],
    weaknesses: ["하락장 장기화 시 ‘종목 묘지’가 될 수 있음", "점검/정리 없으면 수익률이 낮아짐", "평단이 전략이 아니라 습관이 될 위험"],
  },
};
/* -----------------------------
   유틸: 셔플 / 쿼리 파싱
------------------------------ */

function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function qs(name) {
  const u = new URL(window.location.href);
  return u.searchParams.get(name);
}

function setQueryParam(name, value) {
  const u = new URL(window.location.href);
  if (value == null) u.searchParams.delete(name);
  else u.searchParams.set(name, value);
  window.history.replaceState({}, "", u.toString());
}

/* -----------------------------
   렌더: 퀴즈(랜덤), 결과
------------------------------ */

let ORDERED_QUESTIONS = [];
let LAST_RESULT = null; // {type, counts, breakdown, shareLink, shareText}

function renderQuiz(randomize=true) {
  const form = document.getElementById("quiz");
  const quizMsg = document.getElementById("quizMsg");
  quizMsg.style.display = "none";
  quizMsg.innerHTML = "";
  document.getElementById("status").textContent = "";

  ORDERED_QUESTIONS = randomize ? shuffle(QUESTIONS) : QUESTIONS.slice();

  form.innerHTML = ORDERED_QUESTIONS.map((it, idx) => {
    const name = `q${idx}`;
    return `
      <div class="q">
        <div><b>Q${idx+1}. ${escapeHtml(it.q)}</b></div>
        <div class="opts">
          <label><input type="radio" name="${name}" value="A">A) ${escapeHtml(it.A)}</label>
          <label><input type="radio" name="${name}" value="B">B) ${escapeHtml(it.B)}</label>
        </div>
      </div>
    `;
  }).join("");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function calcResultFromForm() {
  const quizMsg = document.getElementById("quizMsg");

  const answers = ORDERED_QUESTIONS.map((_, idx) => {
    const picked = document.querySelector(`input[name="q${idx}"]:checked`);
    return picked ? picked.value : null;
  });

  const missing = answers.findIndex(v => !v);
  if (missing !== -1) {
    quizMsg.style.display = "block";
    quizMsg.innerHTML = `<div class="err">미응답 문항이 있어요: Q${missing+1}을 선택해 주세요.</div>`;
    return null;
  }

  const counts = {
    trend:{A:0,B:0}, basis:{A:0,B:0}, build:{A:0,B:0}, loss:{A:0,B:0}
  };
  answers.forEach((v, i) => counts[ORDERED_QUESTIONS[i].axis][v]++);

  const letters = Object.keys(counts).map(axis => (counts[axis].A > counts[axis].B ? AXIS[axis].A : AXIS[axis].B));
  const type = letters.join("");

  // breakdown pills
  const breakdown = Object.entries(counts).map(([axis, c]) => {
    const picked = (c.A > c.B) ? "A" : "B";
    const letter = (picked === "A") ? AXIS[axis].A : AXIS[axis].B;
    return `<span class="pill">${AXIS[axis].label}: <b>${letter}</b> (A:${c.A}/B:${c.B})</span>`;
  }).join(" ");

  return { type, counts, breakdown };
}

function showResultPage(type, counts, breakdown, fromSharedLink=false) {
  const details = TYPE_DETAILS[type] || {
    identity: "미정 타입",
    tendency: "타입 정보가 아직 준비되지 않았습니다.",
    strengths: [],
    weaknesses: [],
  };

  // share link (?t=TYPE)
  const base = new URL(window.location.href);
  base.hash = "#result";
  base.searchParams.set("t", type);
  const shareLink = base.toString();

  const shareText = `내 주식 MBTI는 ${type} (${details.identity})`;

  LAST_RESULT = { type, counts, breakdown, shareLink, shareText };

  // 페이지 전환
  document.getElementById("page-quiz").style.display = "none";
  document.getElementById("page-result").style.display = "block";
  window.location.hash = "result";

   // ✅ 결과 화면으로 넘어갈 때 스크롤 최상단
  window.scrollTo({ top: 0, left: 0, behavior: "smooth" });

  // 헤더
  document.getElementById("resTitle").textContent = `결과: ${type}`;
  document.getElementById("resSubtitle").textContent = details.identity;

  // 본문
  const main = document.getElementById("resMain");
  const strengths = details.strengths.length
    ? `<ul>${details.strengths.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`
    : `<div class="muted small">준비 중</div>`;
  const weaknesses = details.weaknesses.length
    ? `<ul>${details.weaknesses.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`
    : `<div class="muted small">준비 중</div>`;

  main.innerHTML = `
    <div style="font-size:1.05rem;">
      <b>${escapeHtml(details.identity)}</b>
      ${fromSharedLink ? `<span class="pill">공유 링크로 진입</span>` : ``}
    </div>
    <div class="muted" style="margin-top:6px;">${escapeHtml(details.tendency)}</div>

    <div style="margin-top:10px;">${breakdown || ""}</div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="box">
        <b>강점</b>
        ${strengths}
      </div>
      <div class="box">
        <b>약점</b>
        ${weaknesses}
      </div>
    </div>

    <div class="hr"></div>

    <div class="muted small">
      ※ 재미/자기이해용. 실제 매매에서는 ‘본인 룰(손절/비중/점검 주기)’이 성과를 좌우합니다.
    </div>
  `;

  // 공유 버튼 링크 세팅
  setShareLinks(shareLink, shareText);

  // 공유 카드 캔버스 생성
  drawShareCard(type, details.identity, details.tendency);

  // 웹공유 버튼 활성/비활성
  const webShareBtn = document.getElementById("webShareBtn");
  if (navigator.share) {
    webShareBtn.disabled = false;
  } else {
    webShareBtn.disabled = true;
    webShareBtn.title = "이 브라우저는 Web Share API를 지원하지 않습니다.";
  }

  // 문서 타이틀 정도는 업데이트(플랫폼 OG는 보통 정적 메타만 읽지만, 탭/복사 문구엔 도움)
  document.title = `주식 MBTI 결과: ${type}`;
}

function setShareLinks(url, text) {
  // X(트위터) / Facebook / LinkedIn
  // (참고: 플랫폼별 파라미터는 바뀔 수 있음)
  const x = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
  const fb = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  const li = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;

  document.getElementById("shareX").href = x;
  document.getElementById("shareFB").href = fb;
  document.getElementById("shareLI").href = li;
}

/* -----------------------------
   공유 카드(캔버스)
------------------------------ */

function drawShareCard(type, identity, tendency) {
  const c = document.getElementById("shareCanvas");
  const ctx = c.getContext("2d");
  const W = c.width, H = c.height;

  // background
  ctx.clearRect(0,0,W,H);
  // white
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,W,H);

  // subtle frame
  ctx.strokeStyle = "#e9e9e9";
  ctx.lineWidth = 6;
  roundRect(ctx, 20, 20, W-40, H-40, 26);
  ctx.stroke();

  // top title
  ctx.fillStyle = "#111";
  ctx.font = "700 54px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
  ctx.fillText("주식 MBTI 결과", 70, 120);

  // type big
  ctx.font = "800 120px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
  ctx.fillText(type, 70, 260);

  // identity
  ctx.font = "700 44px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
  wrapText(ctx, identity, 70, 330, W-140, 54);

  // tendency (smaller)
  ctx.fillStyle = "#333";
  ctx.font = "500 32px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
  wrapText(ctx, tendency, 70, 430, W-140, 44);

}

function roundRect(ctx, x, y, w, h, r) {
  const min = Math.min(w,h);
  if (r > min/2) r = min/2;
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = String(text).split(/\s+/);
  let line = "";
  let yy = y;
  for (let n = 0; n < words.length; n++) {
    const testLine = line ? (line + " " + words[n]) : words[n];
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && line) {
      ctx.fillText(line, x, yy);
      line = words[n];
      yy += lineHeight;
    } else {
      line = testLine;
    }
  }
  if (line) ctx.fillText(line, x, yy);
}

/* -----------------------------
   이벤트 핸들러
------------------------------ */

document.getElementById("calcBtn").addEventListener("click", () => {
  const r = calcResultFromForm();
  if (!r) return;
  showResultPage(r.type, r.counts, r.breakdown, false);
});

document.getElementById("resetBtn").addEventListener("click", () => {
  renderQuiz(true);
  window.scrollTo({top:0,behavior:"smooth"});
});

document.getElementById("backBtn").addEventListener("click", () => {
  // 결과에서 문항으로
  document.getElementById("page-result").style.display = "none";
  document.getElementById("page-quiz").style.display = "block";
  document.title = "주식 MBTI 테스트";
  window.location.hash = "";
  setQueryParam("t", null);
  window.scrollTo({top:0,behavior:"smooth"});
});

document.getElementById("retryBtn").addEventListener("click", () => {
  // 재테스트: 문항으로 돌아가면서 랜덤 셔플
  document.getElementById("page-result").style.display = "none";
  document.getElementById("page-quiz").style.display = "block";
  document.title = "주식 MBTI 테스트";
  window.location.hash = "";
  setQueryParam("t", null);
  renderQuiz(true);
  window.scrollTo({top:0,behavior:"smooth"});
});

document.getElementById("copyLinkBtn").addEventListener("click", async () => {
  const st = document.getElementById("shareStatus");
  if (!LAST_RESULT) return;
  try {
    await navigator.clipboard.writeText(LAST_RESULT.shareLink);
    st.textContent = "링크를 복사했어요!";
  } catch {
    st.textContent = "복사 실패(브라우저 권한 확인).";
  }
});

document.getElementById("copyTextBtn").addEventListener("click", async () => {
  const st = document.getElementById("shareStatus");
  if (!LAST_RESULT) return;
  try {
    await navigator.clipboard.writeText(LAST_RESULT.shareText + "\n" + LAST_RESULT.shareLink);
    st.textContent = "결과 문구+링크를 복사했어요!";
  } catch {
    st.textContent = "복사 실패(브라우저 권한 확인).";
  }
});

document.getElementById("webShareBtn").addEventListener("click", async () => {
  const st = document.getElementById("shareStatus");
  if (!LAST_RESULT) return;
  if (!navigator.share) {
    st.textContent = "이 브라우저는 공유 기능을 지원하지 않아요. 링크 복사를 이용해 주세요.";
    return;
  }
  try {
    await navigator.share({
      title: `주식 MBTI 결과: ${LAST_RESULT.type}`,
      text: LAST_RESULT.shareText,
      url: LAST_RESULT.shareLink,
    });
    st.textContent = "공유 완료!";
  } catch {
    st.textContent = "공유가 취소되었거나 실패했어요.";
  }
});

document.getElementById("regenCardBtn").addEventListener("click", () => {
  if (!LAST_RESULT) return;
  const d = TYPE_DETAILS[LAST_RESULT.type];
  drawShareCard(LAST_RESULT.type, d.identity, d.tendency);
  document.getElementById("shareStatus").textContent = "공유 카드를 다시 생성했어요.";
});

document.getElementById("downloadCardBtn").addEventListener("click", () => {
  const st = document.getElementById("shareStatus");
  const c = document.getElementById("shareCanvas");
  const a = document.createElement("a");
  a.download = `stock-mbti-${LAST_RESULT ? LAST_RESULT.type : "result"}.png`;
  a.href = c.toDataURL("image/png");
  a.click();
  st.textContent = "이미지를 저장했어요(다운로드 폴더 확인).";
});

/* -----------------------------
   초기 진입: 공유 링크 (?t=TYPE) 처리
------------------------------ */

function init() {
  // 퀴즈는 항상 랜덤 렌더
  renderQuiz(true);

  const t = (qs("t") || "").toUpperCase().trim();
  if (t && TYPE_DETAILS[t]) {
    // 공유 링크로 바로 결과 진입(문항 응답 없이도)
    const fakeCounts = null;
    const breakdown = `
      <span class="pill">U/D · C/F · K/S · X/A</span>
      <span class="pill">공유 링크로 바로 보기</span>
    `;
    showResultPage(t, fakeCounts, breakdown, true);
  } else {
    // 정상 퀴즈 화면
    document.getElementById("page-quiz").style.display = "block";
    document.getElementById("page-result").style.display = "none";
  }
}
init();
</script>
</body>
</html>
